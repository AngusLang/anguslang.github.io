var WTX=function(e){var t=window.webpackHotUpdateWTX;window.webpackHotUpdateWTX=function(e,r){!function(e,t){if(!g[e]||!x[e])return;for(var r in x[e]=!1,t)Object.prototype.hasOwnProperty.call(t,r)&&(_[r]=t[r]);0==--v&&0===b&&A()}(e,r),t&&t(e,r)};var r,n=!0,i="4e0161c3da3f869b8974",o={},s=[],a=[];function c(e){var t=B[e];if(!t)return M;var n=function(n){return t.hot.active?(B[n]?-1===B[n].parents.indexOf(e)&&B[n].parents.push(e):(s=[e],r=n),-1===t.children.indexOf(n)&&t.children.push(n)):(console.warn("[HMR] unexpected require("+n+") from disposed module "+e),s=[]),M(n)},i=function(e){return{configurable:!0,enumerable:!0,get:function(){return M[e]},set:function(t){M[e]=t}}};for(var o in M)Object.prototype.hasOwnProperty.call(M,o)&&"e"!==o&&"t"!==o&&Object.defineProperty(n,o,i(o));return n.e=function(e){return"ready"===d&&h("prepare"),b++,M.e(e).then(t,(function(e){throw t(),e}));function t(){b--,"prepare"===d&&(y[e]||T(e),0===b&&0===v&&A())}},n.t=function(e,t){return 1&t&&(e=n(e)),M.t(e,-2&t)},n}function u(t){var n={_acceptedDependencies:{},_declinedDependencies:{},_selfAccepted:!1,_selfDeclined:!1,_selfInvalidated:!1,_disposeHandlers:[],_main:r!==t,active:!0,accept:function(e,t){if(void 0===e)n._selfAccepted=!0;else if("function"==typeof e)n._selfAccepted=e;else if("object"==typeof e)for(var r=0;r<e.length;r++)n._acceptedDependencies[e[r]]=t||function(){};else n._acceptedDependencies[e]=t||function(){}},decline:function(e){if(void 0===e)n._selfDeclined=!0;else if("object"==typeof e)for(var t=0;t<e.length;t++)n._declinedDependencies[e[t]]=!0;else n._declinedDependencies[e]=!0},dispose:function(e){n._disposeHandlers.push(e)},addDisposeHandler:function(e){n._disposeHandlers.push(e)},removeDisposeHandler:function(e){var t=n._disposeHandlers.indexOf(e);t>=0&&n._disposeHandlers.splice(t,1)},invalidate:function(){switch(this._selfInvalidated=!0,d){case"idle":(_={})[t]=e[t],h("ready");break;case"ready":R(t);break;case"prepare":case"check":case"dispose":case"apply":(m=m||[]).push(t)}},check:F,apply:P,status:function(e){if(!e)return d;l.push(e)},addStatusHandler:function(e){l.push(e)},removeStatusHandler:function(e){var t=l.indexOf(e);t>=0&&l.splice(t,1)},data:o[t]};return r=void 0,n}var l=[],d="idle";function h(e){d=e;for(var t=0;t<l.length;t++)l[t].call(null,e)}var f,_,p,m,v=0,b=0,y={},x={},g={};function w(e){return+e+""===e?+e:e}function F(e){if("idle"!==d)throw new Error("check() is only allowed in idle status");return n=e,h("check"),(t=1e4,t=t||1e4,new Promise((function(e,r){if("undefined"==typeof XMLHttpRequest)return r(new Error("No browser support"));try{var n=new XMLHttpRequest,o=M.p+""+i+".hot-update.json";n.open("GET",o,!0),n.timeout=t,n.send(null)}catch(e){return r(e)}n.onreadystatechange=function(){if(4===n.readyState)if(0===n.status)r(new Error("Manifest request to "+o+" timed out."));else if(404===n.status)e();else if(200!==n.status&&304!==n.status)r(new Error("Manifest request to "+o+" failed."));else{try{var t=JSON.parse(n.responseText)}catch(e){return void r(e)}e(t)}}}))).then((function(e){if(!e)return h(E()?"ready":"idle"),null;x={},y={},g=e.c,p=e.h,h("prepare");var t=new Promise((function(e,t){f={resolve:e,reject:t}}));_={};return T(0),"prepare"===d&&0===b&&0===v&&A(),t}));var t}function T(e){g[e]?(x[e]=!0,v++,function(e){var t=document.createElement("script");t.charset="utf-8",t.src=M.p+""+e+"."+i+".hot-update.js",document.head.appendChild(t)}(e)):y[e]=!0}function A(){h("ready");var e=f;if(f=null,e)if(n)Promise.resolve().then((function(){return P(n)})).then((function(t){e.resolve(t)}),(function(t){e.reject(t)}));else{var t=[];for(var r in _)Object.prototype.hasOwnProperty.call(_,r)&&t.push(w(r));e.resolve(t)}}function P(t){if("ready"!==d)throw new Error("apply() is only allowed in ready status");return function t(n){var a,c,u,l,d;function f(e){for(var t=[e],r={},n=t.map((function(e){return{chain:[e],id:e}}));n.length>0;){var i=n.pop(),o=i.id,s=i.chain;if((l=B[o])&&(!l.hot._selfAccepted||l.hot._selfInvalidated)){if(l.hot._selfDeclined)return{type:"self-declined",chain:s,moduleId:o};if(l.hot._main)return{type:"unaccepted",chain:s,moduleId:o};for(var a=0;a<l.parents.length;a++){var c=l.parents[a],u=B[c];if(u){if(u.hot._declinedDependencies[o])return{type:"declined",chain:s.concat([c]),moduleId:o,parentId:c};-1===t.indexOf(c)&&(u.hot._acceptedDependencies[o]?(r[c]||(r[c]=[]),v(r[c],[o])):(delete r[c],t.push(c),n.push({chain:s.concat([c]),id:c})))}}}}return{type:"accepted",moduleId:e,outdatedModules:t,outdatedDependencies:r}}function v(e,t){for(var r=0;r<t.length;r++){var n=t[r];-1===e.indexOf(n)&&e.push(n)}}E();var b={},y=[],x={},F=function(){console.warn("[HMR] unexpected require("+A.moduleId+") to disposed module")};for(var T in _)if(Object.prototype.hasOwnProperty.call(_,T)){var A;d=w(T),A=_[T]?f(d):{type:"disposed",moduleId:T};var P=!1,R=!1,O=!1,U="";switch(A.chain&&(U="\nUpdate propagation: "+A.chain.join(" -> ")),A.type){case"self-declined":n.onDeclined&&n.onDeclined(A),n.ignoreDeclined||(P=new Error("Aborted because of self decline: "+A.moduleId+U));break;case"declined":n.onDeclined&&n.onDeclined(A),n.ignoreDeclined||(P=new Error("Aborted because of declined dependency: "+A.moduleId+" in "+A.parentId+U));break;case"unaccepted":n.onUnaccepted&&n.onUnaccepted(A),n.ignoreUnaccepted||(P=new Error("Aborted because "+d+" is not accepted"+U));break;case"accepted":n.onAccepted&&n.onAccepted(A),R=!0;break;case"disposed":n.onDisposed&&n.onDisposed(A),O=!0;break;default:throw new Error("Unexception type "+A.type)}if(P)return h("abort"),Promise.reject(P);if(R)for(d in x[d]=_[d],v(y,A.outdatedModules),A.outdatedDependencies)Object.prototype.hasOwnProperty.call(A.outdatedDependencies,d)&&(b[d]||(b[d]=[]),v(b[d],A.outdatedDependencies[d]));O&&(v(y,[A.moduleId]),x[d]=F)}var S,k=[];for(c=0;c<y.length;c++)d=y[c],B[d]&&B[d].hot._selfAccepted&&x[d]!==F&&!B[d].hot._selfInvalidated&&k.push({module:d,parents:B[d].parents.slice(),errorHandler:B[d].hot._selfAccepted});h("dispose"),Object.keys(g).forEach((function(e){!1===g[e]&&function(e){delete installedChunks[e]}(e)}));var D,C,G=y.slice();for(;G.length>0;)if(d=G.pop(),l=B[d]){var I={},L=l.hot._disposeHandlers;for(u=0;u<L.length;u++)(a=L[u])(I);for(o[d]=I,l.hot.active=!1,delete B[d],delete b[d],u=0;u<l.children.length;u++){var j=B[l.children[u]];j&&((S=j.parents.indexOf(d))>=0&&j.parents.splice(S,1))}}for(d in b)if(Object.prototype.hasOwnProperty.call(b,d)&&(l=B[d]))for(C=b[d],u=0;u<C.length;u++)D=C[u],(S=l.children.indexOf(D))>=0&&l.children.splice(S,1);h("apply"),void 0!==p&&(i=p,p=void 0);for(d in _=void 0,x)Object.prototype.hasOwnProperty.call(x,d)&&(e[d]=x[d]);var N=null;for(d in b)if(Object.prototype.hasOwnProperty.call(b,d)&&(l=B[d])){C=b[d];var z=[];for(c=0;c<C.length;c++)if(D=C[c],a=l.hot._acceptedDependencies[D]){if(-1!==z.indexOf(a))continue;z.push(a)}for(c=0;c<z.length;c++){a=z[c];try{a(C)}catch(e){n.onErrored&&n.onErrored({type:"accept-errored",moduleId:d,dependencyId:C[c],error:e}),n.ignoreErrored||N||(N=e)}}}for(c=0;c<k.length;c++){var V=k[c];d=V.module,s=V.parents,r=d;try{M(d)}catch(e){if("function"==typeof V.errorHandler)try{V.errorHandler(e)}catch(t){n.onErrored&&n.onErrored({type:"self-accept-error-handler-errored",moduleId:d,error:t,originalError:e}),n.ignoreErrored||N||(N=t),N||(N=e)}else n.onErrored&&n.onErrored({type:"self-accept-errored",moduleId:d,error:e}),n.ignoreErrored||N||(N=e)}}if(N)return h("fail"),Promise.reject(N);if(m)return t(n).then((function(e){return y.forEach((function(t){e.indexOf(t)<0&&e.push(t)})),e}));return h("idle"),new Promise((function(e){e(y)}))}(t=t||{})}function E(){if(m)return _||(_={}),m.forEach(R),m=void 0,!0}function R(t){Object.prototype.hasOwnProperty.call(_,t)||(_[t]=e[t])}var B={};function M(t){if(B[t])return B[t].exports;var r=B[t]={i:t,l:!1,exports:{},hot:u(t),parents:(a=s,s=[],a),children:[]};return e[t].call(r.exports,r,r.exports,c(t)),r.l=!0,r.exports}return M.m=e,M.c=B,M.d=function(e,t,r){M.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},M.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},M.t=function(e,t){if(1&t&&(e=M(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(M.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)M.d(r,n,function(t){return e[t]}.bind(null,n));return r},M.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return M.d(t,"a",t),t},M.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},M.p="/",M.h=function(){return i},c(30)(M.s=30)}([function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Vector3=void 0;class n{constructor(e,t,r){this.x=0,this.y=0,this.z=0,this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==r?r:0}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this}add(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this}sub(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this}mult(e){return this.x*=e,this.y*=e,this.z*=e,this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}mag(){return this.x*this.x+this.y*this.y+this.z*this.z}len(){return Math.sqrt(this.mag())}normalize(){return this.mult(1/this.len())}cross(e){return this.cross_vector(this,e)}cross_vector(e,t){return this.set(e.y*t.z-e.z*t.y,e.x*t.z-e.z*t.x,e.x*t.y-e.y*t.x)}set(e,t,r){return this.x=e,this.y=t,this.z=r,this}copy(e){return this.x=e.x,this.y=e.y,this.z=e.z,this}clone(){return new n(this.x,this.y,this.z)}min_element(){return Math.min(this.x,Math.min(this.y,this.z))}max_element(){return Math.max(this.x,Math.max(this.y,this.z))}from_spherical(e){const t=Math.sin(e.theta)*e.radius;return this.x=t*Math.sin(e.phi),this.y=Math.cos(e.theta)*e.radius,this.z=t*Math.cos(e.phi),this}read(e,t=0){return this.x=e[t],this.y=e[t+1],this.z=e[t+2],this}write(e,t=0){return e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,this}}t.Vector3=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GPUFloat=t.GPUUnsignedInt=t.GPUInt=t.GPUUnsignedShort=t.GPUShort=t.GPUUnsignedByte=t.GPUByte=t.GPUBufferDataType=t.ELEMENT_ARRAY_BUFFER=t.ARRAY_BUFFER=t.BufferType=t.TEXTURE_CUBE=t.TEXTURE_3D=t.TEXTURE_2D=t.TextureType=t.RGBA_ASTC_12x12_Format=t.RGBA_ASTC_12x10_Format=t.RGBA_ASTC_10x10_Format=t.RGBA_ASTC_10x8_Format=t.RGBA_ASTC_10x6_Format=t.RGBA_ASTC_10x5_Format=t.RGBA_ASTC_8x8_Format=t.RGBA_ASTC_8x6_Format=t.RGBA_ASTC_8x5_Format=t.RGBA_ASTC_6x6_Format=t.RGBA_ASTC_6x5_Format=t.RGBA_ASTC_5x5_Format=t.RGBA_ASTC_5x4_Format=t.RGBA_ASTC_4x4_Format=t.RGB_ETC1_Format=t.RGBA_PVRTC_2BPPV1_Format=t.RGBA_PVRTC_4BPPV1_Format=t.RGB_PVRTC_2BPPV1_Format=t.RGB_PVRTC_4BPPV1_Format=t.RGBA_S3TC_DXT5_Format=t.RGBA_S3TC_DXT3_Format=t.RGBA_S3TC_DXT1_Format=t.RGB_S3TC_DXT1_Format=t.CompressedPixelFormat=t.RGBIntegerFormat=t.RGIntegerFormat=t.RGFormat=t.RedIntegerFormat=t.RedFormat=t.DepthStencilFormat=t.DepthFormat=t.LuminanceAlphaFormat=t.LuminanceFormat=t.RGBAFormat=t.RGBFormat=t.AlphaFormat=t.PixelFormat=t.HalfFloatType=t.FloatType=t.UnsignedIntType=t.IntType=t.UnsignedShortType=t.ShortType=t.ByteType=t.UnsignedByteType=t.TextureDataType=t.CubeReflectionMapping=t.UVMapping=t.Mapping=t.LinearMipmapLinearFilter=t.LinearMipmapNearestFilter=t.LinearFilter=t.NearestMipmapLinearFilter=t.NearestMipmapNearestFilter=t.NearestFilter=t.TextureFilter=void 0,t.TextureFilter||(t.TextureFilter={}),t.NearestFilter=9728,t.NearestMipmapNearestFilter=9984,t.NearestMipmapLinearFilter=9986,t.LinearFilter=9729,t.LinearMipmapNearestFilter=9985,t.LinearMipmapLinearFilter=9987,t.Mapping||(t.Mapping={}),t.UVMapping=300,t.CubeReflectionMapping=301,t.TextureDataType||(t.TextureDataType={}),t.UnsignedByteType=5121,t.ByteType=5120,t.ShortType=5122,t.UnsignedShortType=5123,t.IntType=5124,t.UnsignedIntType=5125,t.FloatType=5126,t.HalfFloatType=5131,t.PixelFormat||(t.PixelFormat={}),t.AlphaFormat=6406,t.RGBFormat=6407,t.RGBAFormat=6408,t.LuminanceFormat=6409,t.LuminanceAlphaFormat=6410,t.DepthFormat=6145,t.DepthStencilFormat=34041,t.RedFormat=6403,t.RedIntegerFormat=36244,t.RGFormat=33319,t.RGIntegerFormat=33320,t.RGBIntegerFormat=36248,t.CompressedPixelFormat||(t.CompressedPixelFormat={}),t.RGB_S3TC_DXT1_Format=33776,t.RGBA_S3TC_DXT1_Format=33777,t.RGBA_S3TC_DXT3_Format=33778,t.RGBA_S3TC_DXT5_Format=33779,t.RGB_PVRTC_4BPPV1_Format=35840,t.RGB_PVRTC_2BPPV1_Format=35841,t.RGBA_PVRTC_4BPPV1_Format=35842,t.RGBA_PVRTC_2BPPV1_Format=35843,t.RGB_ETC1_Format=36196,t.RGBA_ASTC_4x4_Format=37808,t.RGBA_ASTC_5x4_Format=37809,t.RGBA_ASTC_5x5_Format=37810,t.RGBA_ASTC_6x5_Format=37811,t.RGBA_ASTC_6x6_Format=37812,t.RGBA_ASTC_8x5_Format=37813,t.RGBA_ASTC_8x6_Format=37814,t.RGBA_ASTC_8x8_Format=37815,t.RGBA_ASTC_10x5_Format=37816,t.RGBA_ASTC_10x6_Format=37817,t.RGBA_ASTC_10x8_Format=37818,t.RGBA_ASTC_10x10_Format=37819,t.RGBA_ASTC_12x10_Format=37820,t.RGBA_ASTC_12x12_Format=37821,t.TextureType||(t.TextureType={}),t.TEXTURE_2D=3553,t.TEXTURE_3D=32879,t.TEXTURE_CUBE=34067,t.BufferType||(t.BufferType={}),t.ARRAY_BUFFER=34962,t.ELEMENT_ARRAY_BUFFER=34963,t.GPUBufferDataType||(t.GPUBufferDataType={}),t.GPUByte=5120,t.GPUUnsignedByte=5121,t.GPUShort=5122,t.GPUUnsignedShort=5123,t.GPUInt=5124,t.GPUUnsignedInt=5125,t.GPUFloat=5126},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.KERNEL_RAY_MISSED=t.KERNEL_RAY_CLOSEST_HIT=t.KERNEL_RAY_GENERATE=t.EPSILON=void 0,t.EPSILON=1e-6,t.KERNEL_RAY_GENERATE="ray_generate",t.KERNEL_RAY_CLOSEST_HIT="ray_closest_hit",t.KERNEL_RAY_MISSED="ray_missed"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GPUTextureInternal=t.GPUTextureDescriptor=void 0;const n=r(1);t.GPUTextureDescriptor=class{constructor(){this.minFilter=n.LinearFilter,this.magFilter=n.LinearFilter,this.type=n.TEXTURE_2D,this.dataType=n.FloatType,this.format=n.RGBFormat,this.internalFormat=WebGL2RenderingContext.RGB32F,this.flipY=!0,this.premultiplyAlpha=!1}};t.GPUTextureInternal=class{constructor(e,t){this.device=e;const r=e.getContext();this.texture=r.createTexture(),this.type=t.type,this.internalFormat=t.internalFormat,this.format=t.format,this.dataType=t.dataType,r.bindTexture(t.type,this.texture),r.pixelStorei(r.UNPACK_ALIGNMENT,4),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!0===t.flipY?1:0),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0===t.premultiplyAlpha?1:0),r.texParameteri(t.type,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(t.type,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(t.type,r.TEXTURE_MIN_FILTER,t.minFilter),r.texParameteri(t.type,r.TEXTURE_MAG_FILTER,t.magFilter),r.bindTexture(this.type,null)}bufferData(e,t,r,n=0){const i=this.device.getContext();i.bindTexture(this.type,this.texture),i.texImage2D(this.type,n,this.internalFormat,t,r,0,this.format,this.dataType,e),i.bindTexture(this.type,null)}activate(e){const t=this.device.getContext();t.activeTexture(t.TEXTURE0+e),t.bindTexture(this.type,this.texture)}raw(){return this.texture}delete(){this.device.getContext().deleteTexture(this.texture)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GPUBufferInternal=t.GPUBufferDescriptor=void 0;const n=r(1);t.GPUBufferDescriptor=class{constructor(){this.type=n.ARRAY_BUFFER,this.dataType=n.GPUFloat,this.size=0}};t.GPUBufferInternal=class{constructor(e,t){this.device=e;const r=e.getContext();this.buffer=r.createBuffer(),this.type=t.type,this.dataType=t.dataType,this.size=t.size}bufferData(e){const t=this.device.getContext();t.bindBuffer(this.type,this.buffer),t.bufferData(this.type,e,t.STATIC_DRAW),t.bindBuffer(this.type,null)}activate(e){const t=this.device.getContext();t.bindBuffer(this.type,this.buffer),this.type===n.ARRAY_BUFFER&&(t.vertexAttribPointer(e,this.size,this.dataType,!1,0,0),t.enableVertexAttribArray(e)),t.bindBuffer(this.type,null)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GPUPipeline=t.GPUPipelineDescriptor=void 0;const n=r(6),i=/#include <(.+)>/g,o=/#buffer <(.+)>/g;t.GPUPipelineDescriptor=class{constructor(){this.vertexShader="",this.fragmentShader="",this.defines={}}};t.GPUPipeline=class{constructor(e,t){this.device=e,this.active_texture_slot=0,this.max_texture_slot=16;const r=this.device.getContext();this.vertexShader=t.vertexShader,this.fragmentShader=t.fragmentShader,this.buffers=t.buffers||new Map,this.block=t.block,this.defines=t.defines||{},this.program=r.createProgram(),r.attachShader(this.program,this.compile(this.vertexShader,r.VERTEX_SHADER)),r.attachShader(this.program,this.compile(this.fragmentShader,r.FRAGMENT_SHADER)),r.linkProgram(this.program),this.block&&this.block.locate(this)}flatten(e){let t;for(;t=i.exec(e);){const r=t[0],i=t[1],o=n.ShaderLib.get(i);e=e.replace(r,o)}for(;t=o.exec(e);){const r=t[0],n=t[1],i=this.buffers.get(n);if(!i)throw`buffer ${n} not found.`;const o=i.toString();e=e.replace(r,o)}const r=Object.getOwnPropertyNames(this.defines).map(e=>`#define ${e} ${this.defines[e]}`).join("\n");return e=e.replace("#constants",r)}compile(e,t){const r=this.device.getContext(),n=r.createShader(t);r.shaderSource(n,this.flatten(e)),r.compileShader(n);const i=r.getShaderInfoLog(n);if(""!=i){const t=this.flatten(e).split(/\n/g).map((function(e,t){return`${t+1}:${e}`})).join("\n");console.log(`error in shader:\n${i}\nsource_code:\n' ${t}`)}return n}activate(){this.device.getContext().useProgram(this.program),this.active_texture_slot=0,this.block&&this.block.upload(this)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ShaderLib=void 0;const n=r(31),i=r(32),o=r(33),s=r(34),a=r(35),c=r(36),u=r(37),l=r(38),d=r(2),h=new Map;h.set("stdlib",n),h.set("primitive",i),h.set("trace",o),h.set("light",s),h.set("env_shade",a),h.set(d.KERNEL_RAY_GENERATE,c),h.set(d.KERNEL_RAY_CLOSEST_HIT,u),h.set(d.KERNEL_RAY_MISSED,l);t.ShaderLib=class{static get(e){return h.get(e)}static set(e,t){h.set(e,t)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.math_clamp=t.math_get_max_pot=t.math_equals=void 0;const n=r(2);t.math_equals=function(e,t){return Math.abs(e-t)<n.EPSILON},t.math_get_max_pot=function(e,t){let r=t;for(;e<r;)r>>>=1;return r},t.math_clamp=function(e,t,r){return e<t?t:e>r?r:e}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Vector2=void 0;class n{constructor(e,t){this.x=0,this.y=0,this.x=void 0!==e?e:0,this.y=void 0!==t?t:0}min(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this}max(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this}add(e){return this.x+=e.x,this.y+=e.y,this}sub(e){return this.x-=e.x,this.y-=e.y,this}mult(e){return this.x*=e,this.y*=e,this}dot(e){return this.x*e.x+this.y*e.y}mag(){return this.x*this.x+this.y*this.y}len(){return Math.sqrt(this.mag())}normalize(){return this.mult(1/this.len())}set(e,t){return this.x=e,this.y=t,this}copy(e){return this.x=e.x,this.y=e.y,this}clone(){return new n(this.x,this.y)}min_element(){return Math.min(this.x,this.y)}max_element(){return Math.max(this.x,this.y)}elements(){return new Float32Array([this.x,this.y])}}t.Vector2=n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventHub=t.EventNode=void 0;class n{constructor(){this.listenerMap=new Map}on(e,t,r,n=!1){const i={event:e,callback:t,scope:r||this,once:n},o=this.listenerMap.get(e);if(void 0===o)this.listenerMap.set(e,[i]);else{let e=!1;for(let t=0,r=o.length;t<r;++t)o[t].event===i.event&&o[t].callback===i.callback&&(e=!0,o[t]=i);e||o.push(i)}}once(e,t,r){this.on(e,t,r,!0)}off(e,t,r,n=!1){const i=e,o=t,s=this.listenerMap.get(e);if(s)for(let e=0,t=s.length;e<t;++e)s[e].event===i&&s[e].callback===o&&s.splice(e,1)}fire(e,t){const r=this.listenerMap.get(e);if(r)for(let n=0,i=r.length;n<i;++n){const i=r[n];e===i.event&&(i.callback.bind(i.scope||this),i.callback(t),i.once&&r.splice(n,1))}}dispose(){for(const e of this.listenerMap.keys())this.listenerMap.delete(e)}}t.EventNode=n;class i{static on(e,t,r){this.node.on(e,t,r)}static fire(e,t){this.node.fire(e,t)}static off(e,t,r){this.node.off(e,t,r)}}t.EventHub=i,i.node=new n},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GlobalEvent=void 0,function(e){e.MouseMove="mousemove"}(t.GlobalEvent||(t.GlobalEvent={}))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Target=void 0;const n=r(3),i=r(1);t.Target=class{constructor(e,t,r){this.device=e,this.width=t,this.height=r;const o=this.gl,s=new n.GPUTextureDescriptor;s.format=i.RGBAFormat,s.minFilter=i.NearestFilter,s.magFilter=i.NearestFilter,this.color_attachment=e.createTexture(s);const a=this.color_attachment.raw();o.bindTexture(o.TEXTURE_2D,a),o.texImage2D(o.TEXTURE_2D,0,o.RGBA32F,t,r,0,o.RGBA,o.FLOAT,null),o.bindTexture(o.TEXTURE_2D,null),this.depthBuffer=o.createRenderbuffer(),o.bindRenderbuffer(o.RENDERBUFFER,this.depthBuffer),o.renderbufferStorage(o.RENDERBUFFER,o.DEPTH_COMPONENT16,t,r),o.bindRenderbuffer(o.RENDERBUFFER,null),this.frameBuffer=o.createFramebuffer(),o.bindFramebuffer(o.FRAMEBUFFER,this.frameBuffer),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,a,0),o.framebufferRenderbuffer(o.FRAMEBUFFER,o.DEPTH_ATTACHMENT,o.RENDERBUFFER,this.depthBuffer),o.bindFramebuffer(o.FRAMEBUFFER,null)}get gl(){return this.device.getContext()}bind(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.frameBuffer),e.viewport(0,0,this.width,this.height)}unbind(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}delete(){const e=this.gl;e.deleteRenderbuffer(this.depthBuffer),e.deleteFramebuffer(this.frameBuffer),this.color_attachment.delete()}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Color4=t.Color3=void 0;t.Color3=class{constructor(e,t,r){this.R=void 0!==e?e:0,this.G=void 0!==t?t:0,this.B=void 0!==r?r:0}set(e,t,r){return this.R=e,this.G=t,this.B=r,this}};t.Color4=class{constructor(e,t,r,n){this.R=void 0!==e?e:0,this.G=void 0!==t?t:0,this.B=void 0!==r?r:0,this.A=void 0!==n?n:0}set(e,t,r,n){return this.R=e,this.G=t,this.B=r,this.A=n,this}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GPUDevice=void 0;const n=r(3),i=r(4),o=r(14),s=r(5);t.GPUDevice=class{constructor(e){this.extensions=new Map,this._context=e}get context(){return this._context}getContext(){return this._context}getExtension(e){let t=this.extensions.get(e);return t||(t=this.context.getExtension(e),t?(this.extensions.set(e,t),t):void console.warn(`Extension [${e}] invalid.`))}createTexture(e){return new n.GPUTextureInternal(this,e)}createBuffer(e){return new i.GPUBufferInternal(this,e)}createVertexArray(e){return new o.GPUVertexArrayInternal(this,e)}createPipeline(e){return new s.GPUPipeline(this,e)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GPUVertexArrayInternal=void 0;t.GPUVertexArrayInternal=class{constructor(e,t){this.device=e;const r=e.getContext();this.vertexArrayObject=r.createVertexArray(),r.bindVertexArray(this.vertexArrayObject);for(let e=0;e<t.length;++e)t[e].activate(e);r.bindVertexArray(null)}activate(){this.device.getContext().bindVertexArray(this.vertexArrayObject)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SphericalControl=void 0;const n=r(16),i=r(0),o=r(8),s=r(9),a=r(10),c=r(7);t.SphericalControl=class{constructor(e){this.element=e,this.spherical=new n.Spherical,this.center=new i.Vector3,this.target=new i.Vector3,this.start=new o.Vector2,this.end=new o.Vector2,this.delta=new o.Vector2,this.offset=new i.Vector3,this.speed=1,this.zoomSpeed=.1,this.onmousedown=e=>{window.addEventListener("mousemove",this.onmousemove,!1),window.addEventListener("mouseup",this.onmouseup,!1),this.start.set(e.clientX,e.clientY)},this.onmousemove=e=>{this.end.set(e.clientX,e.clientY),this.delta.copy(this.end).sub(this.start),this.rotate_left(2*Math.PI*this.delta.x/this.element.clientWidth*this.speed),this.rotate_up(2*Math.PI*this.delta.y/this.element.clientHeight*this.speed),this.start.copy(this.end),this.update(),s.EventHub.fire(a.GlobalEvent.MouseMove)},this.onmouseup=e=>{window.removeEventListener("mousemove",this.onmousemove),window.removeEventListener("mouseup",this.onmouseup)},this.onmousewheel=e=>{const t=e;let r=0;void 0!==t.wheelDelta?r=t.wheelDelta:void 0!==t.deltaY&&(r=-t.deltaY),r=r>0?-.1:.1,this.zoom(1+this.zoomSpeed*r),this.update(),s.EventHub.fire(a.GlobalEvent.MouseMove)},e.addEventListener("mousedown",this.onmousedown,!1),e.addEventListener("mousewheel",this.onmousewheel,!1)}rotate_left(e){this.spherical.phi-=e}rotate_up(e){this.spherical.theta=c.math_clamp(this.spherical.theta-e,.001,Math.PI)}zoom(e){this.spherical.radius*=e}update(){this.offset.from_spherical(this.spherical).add(this.center),this.target.copy(this.offset)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Spherical=void 0;const n=r(7);class i{constructor(e,t,r){this.radius=e||1,this.theta=t||0,this.phi=r||0}from_vector3(e){return this.radius=e.len(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.acos(n.math_clamp(e.y/this.radius,-1,1)),this.phi=Math.atan2(e.x,e.z)),this}set(e,t,r){return this.radius=e,this.theta=t,this.phi=r,this}copy(e){return this.set(e.radius,e.theta,e.phi)}clone(){return new i(this.radius,this.theta,this.phi)}}t.Spherical=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Camera=void 0;const n=r(0);t.Camera=class{constructor(e,t){this.fov=e,this.aspect=t,this.up=new n.Vector3(0,1,0),this.position=new n.Vector3,this.forward=new n.Vector3}look_at(e){this.forward.copy(e).sub(this.position).normalize()}write(e,t=0){this.position.write(e,t),this.forward.write(e,t+4),this.up.write(e,t+8),e[t+12]=this.fov}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Engine=void 0;t.Engine=class{constructor(e){this.renderer=e,this.animation_index=-1,this.frame=e=>{this.animation_index=requestAnimationFrame(this.frame)},this.run=()=>{this.start(),this.frame()}}get device(){return this.renderer.device}update(){}start(){}pause(){cancelAnimationFrame(this.animation_index)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bvh_build_geometry=t.bvh_build_geometry_indexed=void 0;const n=r(20),i=r(42),o=r(0);var s;!function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"}(s||(s={}));const a=new n.Box3,c=new o.Vector3,u=new class{constructor(){this.box=new n.Box3,this.count=0,this.index=-1,this.axis=s.X}write(e,t){return this.box.min.write(e,t),this.box.max.write(e,t+3),e[t+6]=this.count,e[t+7]=this.index,e[t+8]=this.axis,this}};let l,d,h,f=0,_=s.X;function p(e,t){return d[9*e+6+_]-d[9*t+6+_]}function m(e){u.box.read(d,9*l[e]),u.index=e,u.count=0,u.axis=_,u.write(h,9*f),f++}t.bvh_build_geometry_indexed=function(e,t){const r=e.length/3;l=new Uint32Array(r),d=new Float32Array(9*r),h=new Float32Array(9*(2*r-1)),console.log(`[bvh_build_geometry_indexed] build bvh tree with number of ${r} triangles`);const n=performance.now();for(let n=0;n<r;++n){l[n]=n,a.reset();for(let r=0;r<3;++r){const i=e[3*n+r];c.read(t,3*i),a.expandByPoint3(c)}const r=9*n;a.write(d,r)}f=0;const o=function e(t,r){if(r-t==1)return m(t),1;if(r-t==2)return m(t),m(r-1),2;u.box.reset();for(let e=t;e<r;++e)a.read(d,9*l[e]),u.box.expandByBox3(a);_=function(e){const t=e.size;switch(t.max_element()){case t.x:return s.X;case t.y:return s.Y;case t.z:return s.Z}return s.X}(u.box),i.QuickSort(l,t,r,p);const n=f;u.axis=_,u.index=t,u.write(h,9*f),f++;const o=t+.5*(r-t)|0,c=e(t,o),v=e(o,r);return h[9*n+6]=c+v,c+v+1}(0,r);console.assert(f===o,`incorrect bvh node count ${f} ${o}.`);const v=new Float32Array(h.buffer,0,9*f);d=void 0,h=void 0;const b=performance.now()-n;console.log(`[bvh_build_geometry_indexed] bvh build finished, cost ${b.toFixed(3)}ms`);const y=new Float32Array(e.length);for(let t=0;t<r;++t){const r=3*t,n=3*l[t];y[r]=e[n],y[r+1]=e[n+1],y[r+2]=e[n+2]}return{nodes:v,index:y,count:f}},t.bvh_build_geometry=function(e){}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Box3=void 0;const n=r(0);class i{constructor(e,t){this.min=new n.Vector3(1/0,1/0,1/0),this.max=new n.Vector3(-1/0,-1/0,-1/0),this._center=new n.Vector3(0,0,0),this._size=new n.Vector3(0,0,0),void 0!==e&&this.min.copy(e),void 0!==t&&this.max.copy(t)}get center(){return this._center.copy(this.max).sub(this.min).mult(.5).add(this.min)}get size(){return this._size.copy(this.max).sub(this.min)}reset(){return this.min.set(1/0,1/0,1/0),this.max.set(-1/0,-1/0,-1/0),this}expandByBox3(e){return this.min.min(e.min),this.max.max(e.max),this}expandByPoint3(e){return this.min.min(e),this.max.max(e),this}clone(){return new i(this.min,this.max)}read(e,t=0){return this.min.read(e,t),this.max.read(e,t+3),this._center.read(e,t+6),this}write(e,t=0){return this.min.write(e,t),this.max.write(e,t+3),this.center.write(e,t+6),this}}t.Box3=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dispose=t.draco_decode=t.draco_set_attribute=t.draco_get_attribute=void 0;const n=new WeakMap,i={};let o=null;const s=[];let a=1,c="";var u;function l(e,t){return new Promise((function(r){fetch("https://www.gstatic.com/draco/v1/decoders/"+e).then((function(e){switch(t){case u.Text:e.text().then((function(e){r(e)}));break;case u.ArrayBuffer:e.arrayBuffer().then((function(e){r(e)}));break;default:throw"unsupported response type"}}))}))}t.draco_get_attribute=function(e,t){for(let r=0;r<e.attributes.length;++r)if(t===e.attributes[r].name)return e.attributes[r]},t.draco_set_attribute=function(e,t,r,n){e.attributes.push({name:t,array:r,itemSize:n})},t.draco_decode=async function(e){return async function(e,t){for(let e in t.attributeTypes){const r=t.attributeTypes[e];void 0!==r.BYTES_PER_ELEMENT&&(t.attributeTypes[e]=r.name)}const r=JSON.stringify(t);if(n.has(e)){const t=n.get(e);if(t.key===r)return t.promise;if(0===e.byteLength)throw new Error("Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let h,f=a++,_=e.byteLength,p=async function(e,t){return async function(){if(o)return o;const e="object"!=typeof WebAssembly||"js"===i.type,t=[];e?t.push(l("draco_decoder.js",u.Text)):(t.push(l("draco_wasm_wrapper.js",u.Text)),t.push(l("draco_decoder.wasm",u.ArrayBuffer)));return o=Promise.all(t).then(t=>{const r=t[0];e||(i.wasmBinary=t[1]);const n=d.toString(),o=["/* draco decoder */",r,"","/* worker */",n.substring(n.indexOf("{")+1,n.lastIndexOf("}"))].join("\n");c=URL.createObjectURL(new Blob([o]))}),o}().then(()=>{if(s.length<4){const e=new Worker(c);e._callbacks={},e._taskCosts={},e._taskLoad=0,e.postMessage({type:"init",decoderConfig:i}),e.onmessage=function(t){const r=t.data;switch(r.type){case"decode":e._callbacks[r.id].resolve(r);break;case"error":e._callbacks[r.id].reject(r);break;default:console.error("DRACOLoader: Unexpected message, "+r.type)}},s.push(e)}else s.sort((function(e,t){return e._taskLoad>t._taskLoad?-1:1}));const r=s[s.length-1];return r._taskCosts[e]=t,r._taskLoad+=t,r})}(f,_).then(r=>(h=r,new Promise((r,n)=>{h._callbacks[f]={resolve:r,reject:n},h.postMessage({type:"decode",id:f,taskConfig:t,buffer:e},[e])}))).then(e=>e.geometry);return p.finally(()=>{h&&f&&function(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}(h,f)}),n.set(e,{key:r,promise:p}),p}(await(await fetch(e)).arrayBuffer(),{attributeIDs:{position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},attributeTypes:{position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"},useUniqueIDs:!1})},function(e){e.Text="text",e.ArrayBuffer="arraybuffer"}(u||(u={})),t.dispose=function(){for(let e=0;e<s.length;++e)s[e].terminate();s.length=0};const d=function(){let e,t;function r(e,t,r,n,i,o){var s,a,c=o.num_components(),u=r.num_points()*c;switch(i){case Float32Array:var l=4*u;s=e._malloc(l),t.GetAttributeDataArrayForAllPoints(r,o,e.DT_FLOAT32,l,s),a=new Float32Array(e.HEAPF32.buffer,s,u).slice(),e._free(s);break;case Int8Array:s=e._malloc(u),t.GetAttributeDataArrayForAllPoints(r,o,e.DT_INT8,u,s),self.geometryBuffer[n]=new Int8Array(e.HEAP8.buffer,s,u).slice(),e._free(s);break;case Int16Array:l=2*u;s=e._malloc(l),t.GetAttributeDataArrayForAllPoints(r,o,e.DT_INT16,l,s),a=new Int16Array(e.HEAP16.buffer,s,u).slice(),e._free(s);break;case Int32Array:l=4*u;s=e._malloc(l),t.GetAttributeDataArrayForAllPoints(r,o,e.DT_INT32,l,s),a=new Int32Array(e.HEAP32.buffer,s,u).slice(),e._free(s);break;case Uint8Array:s=e._malloc(u),t.GetAttributeDataArrayForAllPoints(r,o,e.DT_UINT8,u,s),self.geometryBuffer[n]=new Uint8Array(e.HEAPU8.buffer,s,u).slice(),e._free(s);break;case Uint16Array:l=2*u;s=e._malloc(l),t.GetAttributeDataArrayForAllPoints(r,o,e.DT_UINT16,l,s),a=new Uint16Array(e.HEAPU16.buffer,s,u).slice(),e._free(s);break;case Uint32Array:l=4*u;s=e._malloc(l),t.GetAttributeDataArrayForAllPoints(r,o,e.DT_UINT32,l,s),a=new Uint32Array(e.HEAPU32.buffer,s,u).slice(),e._free(s);break;default:throw new Error("DRACOLoader: Unexpected attribute type.")}return{name:n,array:a,itemSize:c}}onmessage=function(n){const i=n.data;switch(i.type){case"init":e=i.decoderConfig,t=new Promise((function(t){e.onModuleLoaded=function(e){t({draco:e})},self.DracoDecoderModule(e)}));break;case"decode":var o=i.buffer,s=i.taskConfig;t.then(e=>{var t=e.draco,n=new t.Decoder,a=new t.DecoderBuffer;a.Init(new Int8Array(o),o.byteLength);try{var c=function(e,t,n,i){let o,s,a=i.attributeIDs,c=i.attributeTypes,u=t.GetEncodedGeometryType(n);if(u===e.TRIANGULAR_MESH)o=new e.Mesh,s=t.DecodeBufferToMesh(n,o);else{if(u!==e.POINT_CLOUD)throw new Error("DRACOLoader: Unexpected geometry type.");o=new e.PointCloud,s=t.DecodeBufferToPointCloud(n,o)}if(!s.ok()||0===o.ptr)throw new Error("DRACOLoader: Decoding failed: "+s.error_msg());const l={index:null,attributes:[]};for(let n in a){let s,u,d=self[c[n]];if(i.useUniqueIDs)u=a[n],s=t.GetAttributeByUniqueId(o,u);else{if(u=t.GetAttributeId(o,e[a[n]]),-1===u)continue;s=t.GetAttribute(o,u)}l.attributes.push(r(e,t,o,n,d,s))}if(u===e.TRIANGULAR_MESH){var d=3*o.num_faces(),h=4*d,f=e._malloc(h);t.GetTrianglesUInt32Array(o,h,f);var _=new Uint32Array(e.HEAPU32.buffer,f,d).slice();e._free(f),l.index={array:_,itemSize:1}}return e.destroy(o),l}(t,n,a,s),u=c.attributes.map(e=>e.array.buffer);c.index&&u.push(c.index.array.buffer),self.postMessage({type:"decode",id:i.id,geometry:c},u)}catch(e){console.error(e),self.postMessage({type:"error",id:i.id,error:e.message})}finally{t.destroy(a),t.destroy(n)}})}}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TextureBuffer=void 0;const n=r(3),i=r(1);t.TextureBuffer=class{constructor(e,t,r=1){const n=(4096/r|0)*r,i=t.length/3;this.count=i;const o=Math.ceil(i/n),s=new Float32Array(o*n*3);s.set(t),this.width=n,this.height=o,this.data=s,this.name=e,this.stride=r}toString(){const e=this.width,t=this.height,r=this.count,n=this.stride;return function(e,t){const{width:r,height:n,count:i,stride:o}=t;let s="";if(o>1){s=`struct ${e}_block {\n  vec3 a;\n`;for(let e=1;e<o;++e)s+=`  vec3 ${String.fromCharCode(97+e)};\n`;s+="};\n"}let a=`vec3 a = textureLod(${e}_buffer, pos, 0.0).rgb;\n  return a;`;if(o>1){let t="a",r="";a=`vec3 a = textureLod(${e}_buffer, pos, 0.0).rgb;\n`;for(let n=1;n<o;++n)r=String.fromCharCode(97+n),a+=`  vec3 ${r} = textureLodOffset(${e}_buffer, pos, 0.0, ivec2(${n}, 0)).rgb;\n`,t+=", "+r;a+=`  return ${e}_block(${t});`}return`\n#ifndef ${e}_fetch\n#define ${e}_fetch\n\ntexture_buffer_layout ${e}_layout = texture_buffer_layout(${r.toFixed(1)}, ${n.toFixed(1)}, ${i.toFixed(1)}, ${o.toFixed(1)});\nuniform sampler2D ${e}_buffer;\n${s}\n${o>1?e+"_block":"vec3"} fetch_${e}(const float index) {\n  float scalar = index / ${e}_layout.width;\n  float row = floor(scalar) / ${e}_layout.height;\n  float column = fract(scalar);\n  vec2 pos = vec2(0.5 / vec2(${e}_layout.width, ${e}_layout.height)) + vec2(column, row);\n  ${a}\n}\n\n#endif\n`}(this.name,{width:e,height:t,count:r,stride:n})}createGPUTexture(e){const t=new n.GPUTextureDescriptor;t.magFilter=i.NearestFilter,t.minFilter=i.NearestFilter,t.flipY=!1;const r=e.createTexture(t);return r.bufferData(this.data,this.width,this.height),r}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UniformBlock=void 0;const n=r(24),i=r(25),o=r(26),s=r(27),a=r(28);t.UniformBlock=class{constructor(){this.uniforms=[],this.uniform_map=new Map}add_uniform(e){this.uniforms.push(e),this.uniform_map.set(e.name,e)}create_uniform_float(e,t){const r=new a.UniformFloat(e,t);return this.add_uniform(r),r}create_uniform_vector4(e,t,r,i,o){const s=new n.UniformVector4(e,t,r,i,o);return this.add_uniform(s),s}create_uniform_texture(e,t){const r=new i.UniformTexture(e,t);return this.add_uniform(r),r}create_uniform_matrix4(e,t){const r=new o.UniformMatrix4(e,t);return this.add_uniform(r),r}create_uniform_struct(e,t,r){const n=new s.UniformStruct(e,t,r);return this.add_uniform(n),n}get(e){return this.uniform_map.get(e)}locate(e){const t=e.device.getContext();for(let r=0;r<this.uniforms.length;++r){const n=this.uniforms[r];s.isUniformStruct(n)?(n.location=t.getUniformBlockIndex(e.program,n.name),t.uniformBlockBinding(e.program,n.location,n.slot)):n.location=t.getUniformLocation(e.program,n.name)}}upload(e){for(let t=0;t<this.uniforms.length;++t){this.uniforms[t].upload(e)}}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UniformVector4=void 0;t.UniformVector4=class{constructor(e,t,r,n,i){this.name=e,this.x=t||0,this.y=r||0,this.z=n||0,this.w=i||0}set(e,t,r,n){return this.x=e,this.y=t,this.z=r,this.w=n,this}upload(e){e.device.getContext().uniform4f(this.location,this.x,this.y,this.z,this.w)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UniformTexture=void 0;t.UniformTexture=class{constructor(e,t){this.name=e,this.texture=t}set(e){this.texture=e}upload(e){const t=e.device.getContext();if(this.texture.activate(e.active_texture_slot),t.uniform1i(this.location,e.active_texture_slot),e.active_texture_slot++,e.active_texture_slot>e.max_texture_slot)throw"texture slot out of bounds."}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UniformMatrix4=void 0;t.UniformMatrix4=class{constructor(e,t){this.name=e,this.matrix=t}upload(e){e.device.getContext().uniformMatrix4fv(this.location,!1,this.matrix.elements)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UniformStruct=t.isUniformStruct=void 0,t.isUniformStruct=function(e){return!!e.isUniformStruct};t.UniformStruct=class{constructor(e,t,r=0){this.name=e,this.buffer=t,this.slot=r,this.isUniformStruct=!0}upload(e){const t=e.device.getContext();void 0===this.gpu_buffer&&(this.gpu_buffer=t.createBuffer(),t.bindBuffer(t.UNIFORM_BUFFER,this.gpu_buffer),t.bufferData(t.UNIFORM_BUFFER,this.buffer,t.DYNAMIC_DRAW),t.bufferSubData(t.UNIFORM_BUFFER,0,this.buffer),t.bindBufferBase(t.UNIFORM_BUFFER,this.slot,this.gpu_buffer),t.bindBuffer(t.UNIFORM_BUFFER,null)),t.bindBuffer(t.UNIFORM_BUFFER,this.gpu_buffer),t.bufferSubData(t.UNIFORM_BUFFER,0,this.buffer),t.bindBuffer(t.UNIFORM_BUFFER,null)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UniformFloat=void 0;t.UniformFloat=class{constructor(e,t){this.name=e,this.value=t}set(e){return this.value=e,this}upload(e){e.device.getContext().uniform1f(this.location,this.value)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SwapTarget=void 0;const n=r(11);t.SwapTarget=class{constructor(e,t,r){this.device=e,this.width=t,this.height=r,this.front=new n.Target(e,t,r),this.back=new n.Target(e,t,r)}get gl(){return this.device.getContext()}swap(){let e=this.front;this.front=this.back,this.back=e}bind(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,this.front.frameBuffer),e.viewport(0,0,this.width,this.height)}unbind(){const e=this.gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}delete(){this.front.delete(),this.back.delete()}}},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||t.hasOwnProperty(r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),i(r(2),t),i(r(13),t),i(r(39),t),i(r(40),t),i(r(41),t),i(r(52),t),i(r(53),t),i(r(55),t),i(r(58),t),i(r(60),t)},function(e,t){e.exports="#ifndef stdlib\n#define stdlib\n\n#define EPSILON 1e-6\n#define MAX_RAY_DISTANCE 1e10\n#define PI 3.141592653\n#define Naturn_E 2.718281828\n\nstruct ray {\n  vec3 origin, direction;\n};\n\nstruct texture_buffer_layout {\n  float width, height, count, stride;\n};\n\nfloat min_element(vec3 v) {\n  return min(v.x, min(v.y, v.z));\n}\n\nfloat max_element(vec3 v) {\n  return max(v.x, max(v.y, v.z));\n}\n\nbool contain(const vec3 v, const vec3 b, const vec3 t) {\n  return dot(step(b, v), step(v, t)) >= 3.0;\n}\n\nfloat box_intersect(const vec3 minV, const vec3 maxV, const ray r) {\n  vec3 orig = r.origin;\n  vec3 dir = r.direction;\n\n  if (contain(orig, minV, maxV)) {\n    return 0.0;\n  }\n\n  vec3 invDir = 1.0 / dir;\n\n  vec3 bmin = (minV - orig) * invDir;\n  vec3 bmax = (maxV - orig) * invDir;\n\n  vec3 near = min(bmin, bmax);\n  vec3 far = max(bmin, bmax);\n\n  float t_n = max(near.x, max(near.y, near.z));\n  float t_f = min(far.x, min(far.y, far.z));\n\n  if(t_f < 0.0 || t_n > t_f) {\n    return -1.0;\n  }\n\n  return t_n;\n}\n\nfloat rand(const vec2 i){\n  return fract(sin(dot(i.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n\nvec3 linear_to_srgb(vec3 i) {\n  return mix(pow(i, vec3(0.41666)) * 1.055 - vec3(0.055), i * 12.92, vec3(lessThanEqual(i, vec3(0.0031308))));\n}\n\nfloat radical_inverse(uint i) {\n  i = (i << 16u) | (i >> 16u);\n  i = ((i & 0x55555555u) << 1u) | ((i & 0xAAAAAAAAu) >> 1u);\n  i = ((i & 0x33333333u) << 2u) | ((i & 0xCCCCCCCCu) >> 2u);\n  i = ((i & 0x0F0F0F0Fu) << 4u) | ((i & 0xF0F0F0F0u) >> 4u);\n  i = ((i & 0x00FF00FFu) << 8u) | ((i & 0xFF00FF00u) >> 8u);\n  return float(i) * 2.32830643653086963e-10 + fract(rand(uv));\n}\n\nvec3 hemisphere_sample_cos(const vec3 n, vec2 coord) {\n  float phi = coord.y * 2.0 * PI;\n  float cos_theta = sqrt(1.0 - coord.x);\n  float sin_theta = sqrt(1.0 - cos_theta * cos_theta);\n\n  vec3 left = normalize(cross(n, vec3(0.0, 1.0, 0.0)));\n  vec3 up = cross(left, n);\n\n  return normalize(cos(phi) * sin_theta * left + sin(phi) * sin_theta * up + cos_theta * n);\n}\n\nvec3 hammersley_sample_cos(const vec3 n, float i, float count) {\n  return hemisphere_sample_cos(n, vec2(1.0 - i / count, radical_inverse(uint(i))));\n}\n\n#endif"},function(e,t){e.exports="#ifndef primitive_request\n#define primitive_request\n\nstruct primitive_block {\n  vec3 p0, p1, p2, n0, n1, n2;\n};\n\nstruct primitive_intersection {\n  float t, u, v;\n};\n\nprimitive_block fetch_primitive(const float index) {\n  vec3 indices = fetch_index(index);\n\n  vec3 p0 = fetch_position(indices.x);\n  vec3 p1 = fetch_position(indices.y);\n  vec3 p2 = fetch_position(indices.z);\n\n  vec3 n0 = fetch_normal(indices.x);\n  vec3 n1 = fetch_normal(indices.y);\n  vec3 n2 = fetch_normal(indices.z);\n\n  return primitive_block(p0, p1, p2, n0, n1, n2);\n}\n\nvec3 primitive_centriod_normal(const primitive_block p, const float u, const float v) {\n  return p.n0 * (1.0 - u - v) + p.n1 * u + p.n2 * v;\n}\n\n/**\n * double-sided triangle primitive intersect\n **/\nprimitive_intersection primitive_intersect(const primitive_block block, const ray r) {\n  vec3 v1, v2, P, T, Q, orig, dir;\n  primitive_intersection result;\n\n  orig = r.origin;\n  dir = r.direction;\n  v2 = block.p1 - block.p0;\n  v1 = block.p2 - block.p0;\n  result = primitive_intersection(-1.0, 0.0, 0.0);\n  \n  P = cross(dir, v2);\n  float det = dot(v1, P);   //carmer rules devider\n  if (det > -EPSILON && det < EPSILON)\n    return result;\n\n  T = orig - block.p0;\n  float invdet = 1.0 / det;\n\n  float u = dot(T, P) * invdet;\n  if (u < 0.0 || u > 1.0)\n    return result;\n\n  Q = cross(T, v1);\n  float v = dot(dir, Q) * invdet;\n  if (v < 0.0 || u + v > 1.0)\n    return result;\n\n  float t = dot(v2, Q) * invdet;\n  if (t > EPSILON) {\n    return primitive_intersection(t, u, v);\n  }\n  return result;\n}\n\n#endif"},function(e,t){e.exports="#ifndef traverse\n#define traverse\n\n#define IS_LEAF(n) (n.c.x <= EPSILON)\n#define NOT_LEAF(n) (n.c.x > EPSILON)\n#define BVH_BOX_MIN(n) (n.a)\n#define BVH_BOX_MAX(n) (n.b)\n#define BVH_CHILD_COUNT(n) (n.c.x)\n#define BVH_PRIMITIVE_INDEX(n) (n.c.y)\n#define BVH_STRIDE(n) (n.c.z)\n\nstruct trace_result {\n  vec3 position;\n  vec3 normal;\n};\n\nbool trace(const ray r, out trace_result result) {\n  float i, t;\n  bvh_block block;\n  primitive_block p_block, near_primitive;\n  primitive_intersection intersection, near_intersection;\n\n  near_intersection.t = MAX_RAY_DISTANCE;\n\n  for(i = 0.0; i < bvh_layout.count; i += bvh_layout.stride) {\n\n    block = fetch_bvh(i);\n    t = box_intersect(BVH_BOX_MIN(block), BVH_BOX_MAX(block), r);\n    if (t >= 0.0 && t < near_intersection.t) {\n\n      if(IS_LEAF(block)) {\n        p_block = fetch_primitive(BVH_PRIMITIVE_INDEX(block));\n        intersection = primitive_intersect(p_block, r);\n        if (intersection.t > 0.0 && intersection.t < near_intersection.t) {\n          near_intersection = intersection;\n          near_primitive = p_block;\n        }\n      }\n\n    } else {\n      if(NOT_LEAF(block))\n        i += BVH_CHILD_COUNT(block) * bvh_layout.stride - bvh_layout.stride;\n    }\n  }\n\n  if (near_intersection.t < MAX_RAY_DISTANCE) {\n    result.position = r.origin + r.direction * near_intersection.t;\n    result.normal = primitive_centriod_normal(near_primitive, near_intersection.v, near_intersection.u);\n    return true;\n  }\n\n  return false;\n}\n\n// trace\nbool trace_shadow(const ray r) {\n  float t, i;\n  bvh_block block;\n  primitive_block p_block;\n  primitive_intersection intersection;\n\n  for (i = 0.0; i < bvh_layout.count; i += bvh_layout.stride) {\n\n    block = fetch_bvh(i);\n    t = box_intersect(BVH_BOX_MIN(block), BVH_BOX_MAX(block), r);\n    if (t >= 0.0) {\n\n      if(IS_LEAF(block)) {\n        p_block = fetch_primitive(BVH_PRIMITIVE_INDEX(block));\n        intersection = primitive_intersect(p_block, r);\n        if (intersection.t > 0.0)\n          return true;\n      }\n\n    } else {\n      if(NOT_LEAF(block))\n        i += BVH_CHILD_COUNT(block) * bvh_layout.stride;\n    }\n\n  }\n\n  return false;\n}\n\n#endif"},function(e,t){e.exports="#ifndef light_block\n#define light_block\n\nconst float ambientFactor = 0.02;\n\nstruct lightBlock {\n  vec3 position, color;\n  float power;\n};\n\n#endif\n"},function(e,t){e.exports="#ifndef env_shade\n#define env_shade\n\nconst vec3 groundNormal = vec3(0.0, 1.0, 0.0);\nconst float groundOffset = 0.0;\n\nconst vec3 skyColor = vec3(0.318, 0.471, 0.624);\nconst vec3 groundColor = vec3(0.619, 0.607, 0.564);\nconst vec3 up = vec3(0.0, 1.0, 0.0);\n\nvec3 envShade(const vec3 dir, const vec3 orig) {\n  vec3 sampleDir = dir;\n  if (dir.y < 0.0) {\n    float factor = dot(groundNormal, dir);\n    float t = -( dot(orig, groundNormal) + groundOffset) / factor;\n    vec3 hit = orig + dir * t;\n    if(test(hit, sun.position + sunShake - hit)) {\n      return vec3(0.1);\n    }\n    sampleDir = hit;\n    return vec3(0.7);\n  }\n\n  return groundColor + (skyColor - groundColor) * exp(dot(normalize(sampleDir), up));\n}\n\n#endif"},function(e,t){e.exports="/**\n * standard camera ray generate kernel\n **/\nray ray_generate() {\n  vec3 origin = position.xyz;\n  vec3 X = normalize(cross(forward.xyz, up.xyz));\n  vec3 Y = normalize(cross(X, forward.xyz));\n  vec2 aa = ((vec2(rand(uv) - random_seed, rand(uv.yx) - random_seed)) * 2.0) / screen_width;\n  vec2 offset = uv * 2.0 - 1.0 + aa;\n  vec3 direction = normalize(forward.xyz * atan(fov) + X * offset.x + Y * offset.y);\n  return ray(origin, direction);\n}"},function(e,t){e.exports="/**\n * global variable\n * bool terminated; // set true to terminate tracing procedure\n * output vec4 color; // output color\n **/\nray ray_closest_hit(const ray i, const trace_result result) {\n  vec3 reflect_direction = hammersley_sample_cos(result.normal, frame_index, sample_count);\n  ray bounce_ray = ray(result.position + reflect_direction * EPSILON, reflect_direction);\n  bool blocked = trace_shadow(bounce_ray);\n  color += mix(vec4(vec3(1.0), 1.0), vec4(vec3(0.0), 1.0), float(blocked));\n\n  terminated = true;\n  return ray(i.origin, i.direction);\n}"},function(e,t){e.exports="// output vec4 color;\nvoid ray_missed(const ray i) {\n  color = vec4(0.0);\n}"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||t.hasOwnProperty(r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),i(r(15),t)},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||t.hasOwnProperty(r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),i(r(17),t),i(r(18),t),i(r(19),t),i(r(43),t),i(r(49),t),i(r(51),t),i(r(22),t)},function(e,t,r){"use strict";function n(e,t,r,n){for(var i=t+1;i<r;i++){for(var o=e[i],s=i-1;s>=t;s--){var a=e[s];if(!(n(a,o)>0))break;e[s+1]=a}e[s+1]=o}}Object.defineProperty(t,"__esModule",{value:!0}),t.QuickSort=t.InsertionSort=void 0,t.InsertionSort=n,t.QuickSort=function e(t,r,i,o){for(var s=0;;){if(i-r<=10)return void n(t,r,i,o);s=r+(i-r>>1);var a=t[r],c=t[i-1],u=t[s];if(o(a,c)>0){var l=a;a=c,c=l}if(o(a,u)>=0){l=a;a=u,u=c,c=l}else{if(o(c,u)>0){l=c;c=u,u=l}}t[r]=a,t[i-1]=u;var d=c,h=r+1,f=i-1;t[s]=t[h],t[h]=d;e:for(var _=h+1;_<f;_++){var p=t[_],m=o(p,d);if(m<0)t[_]=t[h],t[h]=p,h++;else if(m>0){do{if(--f==_)break e;m=o(t[f],d)}while(m>0);t[_]=t[f],t[f]=p,m<0&&(p=t[_],t[_]=t[h],t[h]=p,h++)}}i-f<h-r?(e(t,f,i,o),i=h):(e(t,r,h,o),r=f)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PathTraceEngine=t.PathTraceMode=void 0;const n=r(5),i=r(21),o=r(44),s=r(19),a=r(22),c=r(23),u=r(18),l=r(17),d=r(15),h=r(45),f=r(46),_=r(47),p=r(48),m=r(29),v=r(9),b=r(10),y=r(11),x=r(6),g=r(2);var w;!function(e){e[e.Render=0]="Render",e[e.Bake=1]="Bake"}(w=t.PathTraceMode||(t.PathTraceMode={}));class F extends u.Engine{constructor(e){super(e),this.renderer=e,this.last_defer_time=0,this.defer_frame_index=0,this.defer_sample_count=200,this.defer_delay=200,this.need_draw=!0,this.mode=w.Render,this.frame=e=>{this.animation_index=requestAnimationFrame(this.frame);const t=e-this.last_defer_time>this.defer_delay&&this.defer_frame_index<this.defer_sample_count;if(this.need_draw)return this.need_draw=!1,this.update(),this.renderer.setPipeline(this.trace_pipeline),void this.renderer.render();t&&(this.render_target.bind(),this.renderer.setPipeline(this.trace_pipeline),this.update(),this.renderer.render(),this.render_target.unbind(),this.swap_target.bind(),this.renderer.setPipeline(this.blend_pipeline),this.blend_block.get("history").set(this.swap_target.back.color_attachment),this.blend_block.get("frame_status").set(this.defer_frame_index,this.defer_sample_count,Math.random(),this.renderer.width),this.renderer.render(),this.swap_target.unbind(),this.swap_target.swap(),this.renderer.setPipeline(this.render_pipeline),this.render_block.get("frame").set(this.swap_target.back.color_attachment),this.renderer.render(),this.defer_frame_index++)},this.swap_target=new m.SwapTarget(this.device,this.renderer.width,this.renderer.height),this.render_target=new y.Target(this.device,this.renderer.width,this.renderer.height),this.trace_pipeline_descriptor=new n.GPUPipelineDescriptor,this.trace_pipeline_descriptor.vertexShader=h,this.trace_pipeline_descriptor.fragmentShader=f,this.trace_pipeline_descriptor.defines.TRACE_DEPTH="2",this.trace_block=new c.UniformBlock,this.trace_pipeline_descriptor.block=this.trace_block,this.blend_pipeline_descriptor=new n.GPUPipelineDescriptor,this.blend_pipeline_descriptor.vertexShader=h,this.blend_pipeline_descriptor.fragmentShader=_,this.blend_block=new c.UniformBlock,this.blend_block.create_uniform_vector4("frame_status",this.defer_frame_index,this.defer_sample_count,Math.random(),-1),this.blend_block.create_uniform_texture("frame",this.render_target.color_attachment),this.blend_block.create_uniform_texture("history",this.swap_target.front.color_attachment),this.blend_pipeline_descriptor.block=this.blend_block,this.blend_pipeline=this.device.createPipeline(this.blend_pipeline_descriptor);const t=new n.GPUPipelineDescriptor;t.vertexShader=h,t.fragmentShader=p,this.render_block=new c.UniformBlock,this.render_block.create_uniform_texture("frame",this.swap_target.back.color_attachment),t.block=this.render_block,this.render_pipeline=this.device.createPipeline(t),this.camera=new l.Camera(Math.PI/2,1),this.camera.position.set(0,0,-2),this.control=new d.SphericalControl(e.canvas),this.control.spherical.from_vector3(this.camera.position),this.camera_uniform=this.trace_block.create_uniform_struct("Camera",new Float32Array(16),0),v.EventHub.on(b.GlobalEvent.MouseMove,()=>{this.need_draw=!0,this.last_defer_time=performance.now(),this.defer_frame_index=0})}set_mode(e){this.mode=e}set_geometry(e){const t=this.device,r=i.draco_get_attribute(e,"position"),n=i.draco_get_attribute(e,"uv");if(void 0===r||void 0===n)throw"require position & uv attribute.";const c=e.index.array,u=r.array,l=n.array;let d=i.draco_get_attribute(e,"normal");if(void 0===d){console.warn("recompute normal attribute");const t=o.compute_normal_indexed(c,u);i.draco_set_attribute(e,"normal",t,3),d=i.draco_get_attribute(e,"normal")}const h=d.array,f=s.bvh_build_geometry_indexed(c,u),_=new a.TextureBuffer("bvh",f.nodes,3),p=new a.TextureBuffer("position",u),m=new a.TextureBuffer("normal",h),v=new a.TextureBuffer("uv",l),b=new a.TextureBuffer("index",f.index),y=new Map;y.set(_.name,_),y.set(p.name,p),y.set(m.name,m),y.set(b.name,b),y.set(v.name,v);const x=_.createGPUTexture(t),g=p.createGPUTexture(t),w=m.createGPUTexture(t),F=b.createGPUTexture(t),T=v.createGPUTexture(t),A=this.trace_block;A.create_uniform_texture(_.name+"_buffer",x),A.create_uniform_texture(p.name+"_buffer",g),A.create_uniform_texture(m.name+"_buffer",w),A.create_uniform_texture(b.name+"_buffer",F),A.create_uniform_texture(v.name+"_buffer",T),A.create_uniform_vector4("frame_status"),this.trace_pipeline_descriptor.buffers=y}set_ray_generate_kernel(e){x.ShaderLib.set(g.KERNEL_RAY_GENERATE,e)}set_closest_hit_kernel(e){x.ShaderLib.set(g.KERNEL_RAY_CLOSEST_HIT,e)}set_missed_kernel(e){x.ShaderLib.set(g.KERNEL_RAY_MISSED,e)}set_bounce_depth(e){this.trace_pipeline_descriptor.defines.TRACE_DEPTH=e.toString()}start(){this.trace_pipeline=this.device.createPipeline(this.trace_pipeline_descriptor),this.renderer.setPipeline(this.trace_pipeline)}update(){const e=this.camera;this.control.update(),e.position.copy(this.control.target),e.look_at(this.control.center),e.write(this.camera_uniform.buffer),this.trace_block.get("frame_status").set(this.defer_frame_index,this.defer_sample_count,Math.random(),this.renderer.width)}}t.PathTraceEngine=F},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.compute_normal_indexed=void 0;const n=r(0),i=new n.Vector3,o=new n.Vector3,s=new n.Vector3,a=new n.Vector3;t.compute_normal_indexed=function(e,t){const r=new Float32Array(t.length);let n,c,u,l;const d=e.length/3;for(let h=0;h<d;++h)n=3*h,c=3*e[n],u=3*e[n+1],l=3*e[n+2],o.read(t,c),s.read(t,u),a.read(t,l),s.sub(o),a.sub(o),o.copy(s).cross(a),s.copy(o),a.copy(o),i.read(r,c).add(o).write(r,c),i.read(r,u).add(s).write(r,u),i.read(r,l).add(a).write(r,l);for(let e=0,t=r.length/3;e<t;++e)n=3*e,i.read(r,n).normalize().write(r,n);return r}},function(e,t){e.exports="#version 300 es\nprecision highp float;\n\nlayout(location = 0) in vec3 position;\n\nout vec2 uv;\n\nvoid main()\n{\n  uv = position.xy * 0.5 + 0.5;\n  gl_Position = vec4(position, 1.0);\n}"},function(e,t){e.exports="#version 300 es\nprecision highp float;\nprecision highp int;\nprecision highp sampler2D;\n#constants\n\n// uniforms\nlayout(std140) uniform Camera {\n  vec4 position;\n  vec4 forward;\n  vec4 up;\n  float fov;\n};\n\n// [frame_index, sample_count, -1, -1]\nuniform vec4 frame_status;\n\n// input & output\nin vec2 uv;\nout vec4 color;\n\nbool terminated = false;\nfloat frame_index, sample_count, random_seed, screen_width;\n\n#include <stdlib>\n#buffer <bvh>\n#buffer <position>\n#buffer <normal>\n#buffer <index>\n#include <primitive>\n#include <trace>\n#include <ray_generate>\n#include <ray_closest_hit>\n#include <ray_missed>\n\nvoid main()\n{\n  // ray create\n  ray r;\n  trace_result result;\n  bool hit;\n\n  frame_index = frame_status.x;\n  sample_count = frame_status.y;\n  random_seed = frame_status.z;\n  screen_width = frame_status.w;\n\n  r = ray_generate();\n\n  int i;\n  for(i = 0; i < TRACE_DEPTH; ++i) {\n    // start tracing \n    hit = trace(r, result);\n    if (hit) {\n      r = ray_closest_hit(r, result);\n    } else {\n      ray_missed(r);\n      break;\n    }\n\n    if (terminated) {\n      break;\n    }\n  }\n\n  color = vec4(linear_to_srgb(color.rgb), color.a);\n}"},function(e,t){e.exports="#version 300 es\nprecision lowp float;\nprecision lowp sampler2D;\n\nuniform sampler2D history;\nuniform sampler2D frame;\n\n// [frame_index, sample_count, random_seed, -1]\nuniform vec4 frame_status;\n\nin vec2 uv;\nout vec4 color;\n\nvoid main()\n{\n  float index = frame_status.x + 1.0;\n  color = mix(texture(history, uv), texture(frame, uv), 1.0 / index);\n}"},function(e,t){e.exports="#version 300 es\nprecision lowp float;\nprecision lowp sampler2D;\n\nuniform sampler2D frame;\n\nin vec2 uv;\nout vec4 color;\n\n#include <stdlib>\n\nvoid main()\n{\n  color = texture(frame, uv);\n}"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Renderer=void 0;const n=r(13),i=r(50),o=r(12);t.Renderer=class{constructor(e){this.canvas=e,this.animation_index=-1,this.clear_color=new o.Color4(0,0,0,0);const t=e.getContext("webgl2",{preserveDrawingBuffer:!0,antialias:!1});if(!t)throw alert("require webgl2.0 supported."),"require webgl2.0 supported.";this.device=new n.GPUDevice(t);const r=1.5*window.devicePixelRatio;this.width=e.width*r,this.height=e.height*r,e.width=this.width,e.height=this.height,t.viewport(0,0,this.width,this.height),this.device.getExtension("EXT_color_buffer_float"),this.device.getExtension("OES_texture_float_linear"),e.oncontextmenu=function(e){e.preventDefault(),e.stopPropagation()},this.screenQuadVertexArray=i.createScreenQuad(this.device)}clear(e,t,r){const n=this.device.getContext(),i=this.clear_color;e&&n.clearColor(i.R,i.G,i.B,i.A);let o=0;e&&(o|=n.COLOR_BUFFER_BIT),t&&(o|=n.DEPTH_BUFFER_BIT),r&&(o|=n.STENCIL_BUFFER_BIT),n.clear(o)}render(){if(this.pipeline){this.pipeline.activate();const e=this.device.getContext();this.screenQuadVertexArray.activate(),e.drawArrays(e.TRIANGLES,0,6),e.bindVertexArray(null)}}setPipeline(e){this.pipeline=e,this.pipeline.activate()}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createScreenQuad=void 0;const n=r(4),i=r(1);let o;t.createScreenQuad=function(e){if(void 0!==o)return o;const t=new Float32Array([-1,-1,0,1,-1,0,1,1,0,1,1,0,-1,1,0,-1,-1,0]),r=new n.GPUBufferDescriptor;r.size=3,r.dataType=i.GPUFloat,r.type=i.ARRAY_BUFFER;const s=e.createBuffer(r);return s.bufferData(t),o=e.createVertexArray([s]),o}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SceneBVH=void 0;t.SceneBVH=class{}},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||t.hasOwnProperty(r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),i(r(9),t),i(r(10),t)},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||t.hasOwnProperty(r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),i(r(21),t),i(r(54),t)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OBJLoader=t.MTLData=t.MaterialNode=t.OBJData=t.OBJPackage=void 0;const n=r(12),i=/\s+/,o=/^v\s/,s=/^vn\s/,a=/^f\s/,c=/^usemtl\s/,u=/^Ns\s/,l=/^Ka\s/,d=/^Kd\s/,h=/^Ks\s/,f=/^Ni\s/,_=/^d\s/,p=/^newmtl\s/;class m{constructor(e,t){this.objData=e,this.mtlData=t}}t.OBJPackage=m;class v{constructor(e,t,r){this.vertices=e,this.normals=t,this.faces=r}}t.OBJData=v;class b{constructor(e){this.name=e,this.ambient=new n.Color3,this.diffuse=new n.Color3,this.specular=new n.Color3,this.roughness=96,this.opacity=1,this.refract=1}}t.MaterialNode=b;class y{constructor(e){this.materials=e}}t.MTLData=y,t.OBJLoader=async function(e,t){const r=await fetch(e+"/"+t+".mtl"),n=function(e){const t=[];let r;const n=e.split("\n");let o=-1;for(;++o<n.length;){const e=n[o].trim(),s=e.split(i);s.shift(),p.test(e)?(r&&t.push(r),r=new b(s[0])):l.test(e)?r&&r.ambient.set(parseFloat(s[0]),parseFloat(s[1]),parseFloat(s[2])):d.test(e)?r&&r.diffuse.set(parseFloat(s[0]),parseFloat(s[1]),parseFloat(s[2])):h.test(e)?r&&r.specular.set(parseFloat(s[0]),parseFloat(s[1]),parseFloat(s[2])):u.test(e)?r&&(r.roughness=parseFloat(s[0])):_.test(e)?r&&(r.opacity=parseFloat(s[0])):f.test(e)&&r&&(r.refract=parseFloat(s[0]))}return t.push(r),t}(await r.text()),x=await fetch(e+"/"+t+".obj"),g=await x.text();return new m(function(e,t){const r=[],n=[],u=[];let l=-1;const d=e.split("\n");let h=-1;for(;++h<d.length;){const e=d[h].trim(),_=e.split(i);if(_.shift(),o.test(e))r.push([parseFloat(_[0]),parseFloat(_[1]),parseFloat(_[2])]);else if(s.test(e))n.push([parseFloat(_[0]),parseFloat(_[1]),parseFloat(_[2])]);else if(a.test(e)){let e=-1,t=[];for(;++e<_.length;){var f=_[e].split("/");t.push(parseFloat(f[0])-1,parseFloat(f[2])-1,l)}u.push(t)}else if(c.test(e)&&t.length>0){const e=_[0];let r=0;for(;r<t.length;++r)e!==t[r].name||(l=r)}}return new v(r,n,u)}(g,n),new y(n))}},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||t.hasOwnProperty(r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),i(r(20),t),i(r(12),t),i(r(56),t),i(r(7),t),i(r(57),t),i(r(16),t),i(r(8),t),i(r(0),t)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Matrix4=void 0;const n=r(0);let i=new n.Vector3,o=new n.Vector3,s=new n.Vector3;const a=180/Math.PI;class c{constructor(){this.elements=new Float32Array(16),this.identity()}identity(){return this.elements.set([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this}copy(e){return this.read(e.elements),this}clone(){return(new c).read(this.elements)}set(e,t,r,n,i,o,s,a,c,u,l,d,h,f,_,p){const m=this.elements;return m[0]=e,m[4]=t,m[8]=r,m[12]=n,m[1]=i,m[5]=o,m[9]=s,m[13]=a,m[2]=c,m[6]=u,m[10]=l,m[14]=d,m[3]=h,m[7]=f,m[11]=_,m[15]=p,this}read(e,t){t=void 0===t?0:t;for(let r=0;r<16;++r)this.elements[r]=e[r+t];return this}set_position(e){const t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this}make_position(e){return this.set(1,0,0,e.x,0,1,0,e.y,0,0,1,e.z,0,0,0,1),this}transpose(){const e=this.elements;let t;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}look_at(e,t,r){const n=this.elements;return s.copy(e).sub(t),0===s.mag()&&(s.z=1),s.normalize(),i.cross_vector(r,s),0===i.mag()&&(1===Math.abs(r.z)?s.x+=1e-4:s.z+=1e-4,s.normalize(),i.cross_vector(r,s)),i.normalize(),o.cross_vector(s,i),n[0]=i.x,n[4]=o.x,n[8]=s.x,n[1]=i.y,n[5]=o.y,n[9]=s.y,n[2]=i.z,n[6]=o.z,n[10]=s.z,this}inverse(e){const t=this.elements,r=e.elements,n=r[0],i=r[1],o=r[2],s=r[3],a=r[4],c=r[5],u=r[6],l=r[7],d=r[8],h=r[9],f=r[10],_=r[11],p=r[12],m=r[13],v=r[14],b=r[15],y=h*v*l-m*f*l+m*u*_-c*v*_-h*u*b+c*f*b,x=p*f*l-d*v*l-p*u*_+a*v*_+d*u*b-a*f*b,g=d*m*l-p*h*l+p*c*_-a*m*_-d*c*b+a*h*b,w=p*h*u-d*m*u-p*c*f+a*m*f+d*c*v-a*h*v,F=n*y+i*x+o*g+s*w;if(0===F)return this.identity();const T=1/F;return t[0]=y*T,t[1]=(m*f*s-h*v*s-m*o*_+i*v*_+h*o*b-i*f*b)*T,t[2]=(c*v*s-m*u*s+m*o*l-i*v*l-c*o*b+i*u*b)*T,t[3]=(h*u*s-c*f*s-h*o*l+i*f*l+c*o*_-i*u*_)*T,t[4]=x*T,t[5]=(d*v*s-p*f*s+p*o*_-n*v*_-d*o*b+n*f*b)*T,t[6]=(p*u*s-a*v*s-p*o*l+n*v*l+a*o*b-n*u*b)*T,t[7]=(a*f*s-d*u*s+d*o*l-n*f*l-a*o*_+n*u*_)*T,t[8]=g*T,t[9]=(p*h*s-d*m*s-p*i*_+n*m*_+d*i*b-n*h*b)*T,t[10]=(a*m*s-p*c*s+p*i*l-n*m*l-a*i*b+n*c*b)*T,t[11]=(d*c*s-a*h*s-d*i*l+n*h*l+a*i*_-n*c*_)*T,t[12]=w*T,t[13]=(d*m*o-p*h*o+p*i*f-n*m*f-d*i*v+n*h*v)*T,t[14]=(p*c*o-a*m*o-p*i*u+n*m*u+a*i*v-n*c*v)*T,t[15]=(a*h*o-d*c*o+d*i*u-n*h*u-a*i*f+n*c*f)*T,this}make_perspective(e,t,r,n){this.identity();const i=this.elements,o=r*Math.tan(.5*a*e),s=-o,c=o*t,u=-c,l=2*r/(u-c),d=2*r/(o-s),h=(u+c)/(u-c),f=(o+s)/(o-s),_=-(n+r)/(n-r),p=-2*n*r/(n-r);return i[0]=l,i[4]=0,i[8]=h,i[12]=0,i[1]=0,i[5]=d,i[9]=f,i[13]=0,i[2]=0,i[6]=0,i[10]=_,i[14]=p,i[3]=0,i[7]=0,i[11]=-1,i[15]=0,this}multiply_matrix(e,t){const r=e.elements,n=t.elements,i=this.elements,o=r[0],s=r[4],a=r[8],c=r[12],u=r[1],l=r[5],d=r[9],h=r[13],f=r[2],_=r[6],p=r[10],m=r[14],v=r[3],b=r[7],y=r[11],x=r[15],g=n[0],w=n[4],F=n[8],T=n[12],A=n[1],P=n[5],E=n[9],R=n[13],B=n[2],M=n[6],O=n[10],U=n[14],S=n[3],k=n[7],D=n[11],C=n[15];return i[0]=o*g+s*A+a*B+c*S,i[4]=o*w+s*P+a*M+c*k,i[8]=o*F+s*E+a*O+c*D,i[12]=o*T+s*R+a*U+c*C,i[1]=u*g+l*A+d*B+h*S,i[5]=u*w+l*P+d*M+h*k,i[9]=u*F+l*E+d*O+h*D,i[13]=u*T+l*R+d*U+h*C,i[2]=f*g+_*A+p*B+m*S,i[6]=f*w+_*P+p*M+m*k,i[10]=f*F+_*E+p*O+m*D,i[14]=f*T+_*R+p*U+m*C,i[3]=v*g+b*A+y*B+x*S,i[7]=v*w+b*P+y*M+x*k,i[11]=v*F+b*E+y*O+x*D,i[15]=v*T+b*R+y*U+x*C,this}multiply(e){return this.multiply_matrix(this,e)}scale(e){const t=this.elements,r=e.x,n=e.y,i=e.z;return t[0]*=r,t[4]*=n,t[8]*=i,t[1]*=r,t[5]*=n,t[9]*=i,t[2]*=r,t[6]*=n,t[10]*=i,t[3]*=r,t[7]*=n,t[11]*=i,this}preMultiply(e){return this.multiply_matrix(e,this)}}t.Matrix4=c},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rect=void 0;const n=r(8);t.Rect=class{constructor(e,t,r,i){this.origin=new n.Vector2(e,t),this.size=new n.Vector2(r,i)}width(){return this.size.x}height(){return this.size.y}translate(e,t){return this.origin.x+=e,this.origin.y+=t,this}scale(e,t){return this.size.x*=e,this.size.y*=t,this}}},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||t.hasOwnProperty(r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),i(r(59),t)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BlobReader=void 0,t.BlobReader=function(e){const t=new FileReader;return new Promise((function(r,n){t.addEventListener("loadend",(function(e){r(new Float32Array(t.result))}),!1),t.readAsArrayBuffer(e)}))}},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||t.hasOwnProperty(r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),i(r(61),t),i(r(4),t),i(r(5),t),i(r(6),t),i(r(29),t),i(r(11),t),i(r(3),t),i(r(23),t),i(r(14),t),i(r(1),t)},function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||t.hasOwnProperty(r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),i(r(62),t),i(r(28),t),i(r(26),t),i(r(27),t),i(r(25),t),i(r(63),t),i(r(24),t)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.UniformVector3=void 0;const n=r(0);t.UniformVector3=class{constructor(e,t){this.name=e,this.v=new n.Vector3,this.v.copy(t)}set(e){return this.v.copy(e),this}upload(e){e.device.getContext().uniform3f(this.location,this.v.x,this.v.y,this.v.z)}}}]);